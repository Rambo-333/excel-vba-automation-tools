# Excelファイル分析レポート

## 1. フォルダ構造

```
c:\Users\doitu\Desktop\dev\excel\
├── 基幹システム連携.xlsm (29.05 KB)
└── 検査証_一般.xlsm (129.02 KB)
```

---

## 2. ファイル一覧

| ファイル名 | 種類 | サイズ | VBAプロジェクト |
|-----------|------|--------|----------------|
| 基幹システム連携.xlsm | Excel Macro-Enabled Workbook | 29.05 KB | あり (52,224 bytes) |
| 検査証_一般.xlsm | Excel Macro-Enabled Workbook | 129.02 KB | あり (118,272 bytes) |

---

## 3. 各ファイルの概要

### 3.1 基幹システム連携.xlsm

**目的**: 基幹システム（QBIS）への発注データ入力を自動化するツール

**ワークシート構成**:
- Sheet1 (メインシート)
- Commands
- microsoft.com:RD
- microsoft.com:Single
- microsoft.com:FV
- microsoft.com:CNMTM
- microsoft.com:LET_WF

**機能概要**:
- Excelシートから発注情報を読み取る
- 基幹システム（QBIS）ウィンドウを自動操作
- SendKeysを使用してフォーム入力を自動化
- マウス操作の自動化（座標計算とクリック）

**VBAモジュール構成**:

| モジュール名 | 種類 | 行数（概算） | 説明 |
|------------|------|------------|------|
| ThisWorkbook | Class Module | 2 | ワークブック初期化 |
| Sheet1 | Class Module | 2 | シートイベント |
| Module1 | Standard Module | 180 | メイン処理（非リファクタリング版） |
| Module2 | Standard Module | 130 | リファクタリング版（関数分割） |
| Module3 | Standard Module | 25 | さらなるリファクタリング版（クラス利用） |
| OrderData | Class Module | 80 | 発注データ管理クラス |
| QBISOperator | Class Module | 75 | QBIS操作クラス |

**コード構造の特徴**:
- Module1: 初期実装（手続き型、全処理が1つのSub内）
- Module2: 中間リファクタリング（関数分割、Dictionary活用）
- Module3: 最終リファクタリング（クラス設計、責務分離）
→ **開発の過程が保存されている**

---

### 3.2 検査証_一般.xlsm

**目的**: 検査証データの管理・印刷システム

**ワークシート構成**:
- set (設定シート)
- 入力 (データ入力シート)
- print (印刷用シート)
- microsoft.com:RD
- microsoft.com:Single
- microsoft.com:FV
- microsoft.com:CNMTM
- microsoft.com:LET_WF

**機能概要**:
1. 外部Excelファイルから過去データをインポート
2. 日付範囲によるフィルタリング
3. データの並び替え・集計
4. 数量の分割・統合処理
5. 検査証の印刷（最大32件、8件/ページ）

**VBAモジュール構成**:

| モジュール名 | 種類 | 行数（概算） | 説明 |
|------------|------|------------|------|
| ThisWorkbook | Class Module | 2 | ワークブック初期化 |
| Sheet1 | Class Module | 2 | データ入力シート |
| Sheet3 | Class Module | 70 | 日付検証イベント処理 |
| Sheet4 | Class Module | 2 | 印刷シート |
| WorkbookManager | Class Module | 28 | 外部ブック管理 |
| import | Standard Module | 215 | データインポート処理 |
| Adjust | Standard Module | 135 | 数量分割処理 |
| printing | Standard Module | 60 | 印刷処理 |
| Module1 | Standard Module | 108 | 数量統合処理 |

**主要機能詳細**:

#### データインポート機能 (import.bas)
- 外部ブック: `ああああ.xlsx` のシート `xxx` からデータ取得
- フィルター列: AA列（D列キー）またはAF列（E列キー）
- 取得列: AA, AF, E, C, H, I, J, K, L, M, N, O, P, AL, Y, Z, AN
- 日付範囲フィルタリング後、データを配列に格納
- 条件付き書式変換（φ, t 接頭辞、特別品マーク）

#### 数量分割機能 (Adjust.bas)
- Q列の数量を2?5分割
- 分割後、R列に識別子を自動付与（例: 元ID-1, 元ID-2）
- 色コードでハイライト表示

#### 数量統合機能 (Module1.bas)
- R列の識別子をもとに分割データを再統合
- 数量を合計して代表行に反映
- 不要行をクリア後、並び替え実行

#### 印刷機能 (printing.bas)
- 最大32件まで印刷可能
- 8件/ページで自動ページネーション
- U列・V列のエラーチェック

---

## 4. 機密情報の確認

### 検出された機密情報リスク

| ファイル | リスクレベル | 検出項目 | 詳細 |
|---------|------------|---------|------|
| 基幹システム連携.xlsm | **中** | 基幹システム名 | コード内に「QBIS」システム名が記載（マスク可能） |
| 検査証_一般.xlsm | **低** | 外部ファイル参照 | `ああああ.xlsx` / シート名 `xxx` - ダミー名使用済み |
| 両ファイル | **低** | 個人情報パターン | 共有文字列に住所・氏名などのパターンは検出されず |

### 安全性評価

#### ポジティブ要素:
- ✓ パスワード・認証情報の記載なし
- ✓ 外部接続ファイル（.iqy, .odc等）は検出されず
- ✓ データベース接続文字列なし
- ✓ 個人を特定できる情報は検出されず

#### 注意が必要な要素:
- ⚠ `基幹システム連携.xlsm` が特定のアプリケーション「QBIS」に依存
- ⚠ `検査証_一般.xlsm` が外部ファイル `ああああ.xlsx` に依存
- ⚠ セル座標によるデータ参照（行番号ハードコーディング）

---

## 5. VBAコードのモジュール構成

### 5.1 基幹システム連携.xlsm のモジュール構成

```
xl/vbaProject.bin
├── VBA/
│   ├── ThisWorkbook.cls (ワークブックイベント)
│   ├── Sheet1.cls (シートイベント)
│   ├── Module1.bas (初期実装 - 手続き型)
│   │   └── Sub CoreSystemOperation()
│   │       ├── 事前確認ダイアログ
│   │       ├── Excelシートからデータ読み込み
│   │       ├── 単位辞書変換
│   │       ├── QBISウィンドウ情報取得
│   │       ├── SendKeysによるフォーム入力
│   │       ├── マウス座標計算・クリック
│   │       └── 備考入力
│   │
│   ├── Module2.bas (中間リファクタリング - 関数分割)
│   │   ├── Function ConfirmMainScreen()
│   │   ├── Function GetInputData() → Dictionary
│   │   ├── Function GetUnitNumber() → Variant
│   │   ├── Function GetWindowInfo() → Dictionary
│   │   ├── Sub SendDataTovvv()
│   │   ├── Sub MoveMouse()
│   │   └── Sub SendNote()
│   │
│   ├── Module3.bas (最終リファクタリング - クラス活用)
│   │   └── Sub CoreSystemOperation()
│   │       ├── OrderData.LoadFromSheet()
│   │       ├── QBISOperator.Initialize()
│   │       ├── QBISOperator.SendOrderData()
│   │       └── QBISOperator.SendNote()
│   │
│   ├── OrderData.cls (発注データクラス)
│   │   ├── Properties: Requester, RequestingDepartment, ...
│   │   ├── Sub LoadFromSheet(resizeValue)
│   │   ├── Function GetUnitNumber()
│   │   ├── Sub CopyProductName()
│   │   └── Sub CopyNote()
│   │
│   └── QBISOperator.cls (QBIS操作クラス)
│       ├── Private: winLeft, winTop, winWidth, winHeight
│       ├── Sub Initialize()
│       ├── Sub SendOrderData(data As OrderData)
│       ├── Sub SendNote(noteText)
│       └── Sub MoveMouse()
```

**使用API**:
- `GetForegroundWindow` (ウィンドウハンドル取得)
- `GetWindowPlacement` (ウィンドウ情報取得)
- `SetCursorPos` (マウスカーソル移動)
- `mouse_event` (マウスクリック)

**外部オブジェクト**:
- `WScript.Shell` (SendKeys, AppActivate)
- `Scripting.Dictionary` (単位変換辞書)

---

### 5.2 検査証_一般.xlsm のモジュール構成

```
xl/vbaProject.bin
├── VBA/
│   ├── ThisWorkbook.cls
│   ├── Sheet1.cls (入力シート)
│   ├── Sheet3.cls (日付検証シート)
│   │   ├── Private Sub Worksheet_Change(Target)
│   │   │   └── 日付整合性チェック
│   │   └── Private Sub HandleDateValidation()
│   │
│   ├── Sheet4.cls (印刷シート)
│   │
│   ├── WorkbookManager.cls (外部ブック管理)
│   │   ├── Function OpenWorkbook() → Workbook
│   │   └── Sub CloseIfNeeded()
│   │
│   ├── import.bas (データインポート)
│   │   ├── Sub dataImport(refCell, inputCell)
│   │   │   ├── 外部ブックを開く
│   │   │   ├── AutoFilterで日付範囲フィルタ
│   │   │   ├── CountIfsで件数カウント
│   │   │   ├── SpecialCells(xlCellTypeVisible)で可視セル取得
│   │   │   ├── 配列にデータ格納
│   │   │   ├── FormatPastData()でデータ整形
│   │   │   └── 貼り付け・並び替え
│   │   │
│   │   └── Function FormatPastData()
│   │       ├── φ, t 接頭辞付与
│   │       └── 「特別品」マーク処理
│   │
│   ├── Adjust.bas (数量分割)
│   │   ├── Sub SplitQuantity()
│   │   │   ├── InputBoxでQ列セル選択
│   │   │   ├── 分割数入力（2?5）
│   │   │   ├── 各分割の数量入力
│   │   │   ├── 合計チェック
│   │   │   ├── 元行更新（ID-1）
│   │   │   └── 新規行追加（ID-2 ? ID-n）
│   │   │
│   │   └── Function IsCancelledOrEmpty()
│   │
│   ├── printing.bas (印刷)
│   │   └── Sub PrintPreparedData()
│   │       ├── データ件数チェック（≤32）
│   │       ├── U・V列エラーチェック
│   │       ├── ページ数計算（8件/ページ）
│   │       └── PrintOut実行
│   │
│   └── Module1.bas (数量統合)
│       └── Sub MergeQuantityByIdentifier()
│           ├── InputBoxでR列セル選択
│           ├── 基本ID抽出（-の前）
│           ├── 統合対象行収集
│           ├── 数量合計
│           ├── 代表行更新
│           ├── 他行クリア
│           └── 並び替え
```

**イベントドリブン処理**:
- `Worksheet_Change` (Sheet3): D3/E3の変更を監視し、自動的にdataImport()を呼び出す

**データフロー**:
```
ユーザー入力 (D3/E3)
  → Worksheet_Change イベント
    → HandleDateValidation (日付検証)
      → dataImport (外部データ取得)
        → FormatPastData (データ整形)
          → シート貼り付け・並び替え
```

---

## 6. セキュリティ分析（olevbaによる検出）

### 基幹システム連携.xlsm

| タイプ | キーワード | 説明 | リスク評価 |
|--------|-----------|------|-----------|
| Suspicious | Shell | 実行ファイルやシステムコマンドを実行する可能性 | **正当な用途**: SendKeys用のWScript.Shell |
| Suspicious | Wscript.Shell | 実行ファイルやシステムコマンドを実行する可能性 | **正当な用途**: UI自動化 |
| Suspicious | CreateObject | OLEオブジェクトを作成する可能性 | **正当な用途**: Dictionary, Shell |
| Suspicious | SendKeys | キー入力シミュレーション | **正当な用途**: フォーム自動入力 |
| Suspicious | AppActivate | ウィンドウの切り替え | **正当な用途**: QBIS/Excel切替 |
| Suspicious | Hex Strings | 16進エンコード文字列 | **低リスク**: 通常のVBA内部データ |
| Suspicious | Base64 Strings | Base64エンコード文字列 | **低リスク**: 通常のVBA内部データ |

**総合評価**: **安全**
→ すべて業務自動化の正当な用途で使用されている

---

### 検査証_一般.xlsm

| タイプ | キーワード | 説明 | リスク評価 |
|--------|-----------|------|-----------|
| AutoExec | Worksheet_Change | ファイルオープン時に自動実行 | **正当な用途**: 日付検証イベント |
| Suspicious | Open | ファイルを開く可能性 | **正当な用途**: 外部ブック読込 |
| Suspicious | Call | DLL呼び出し | **低リスク**: VBAのCall文 |
| Suspicious | Hex Strings | 16進エンコード文字列 | **低リスク**: 通常のVBA内部データ |
| Suspicious | Base64 Strings | Base64エンコード文字列 | **低リスク**: 通常のVBA内部データ |
| **Suspicious** | **VBA Stomping** | **VBAソースコードとP-codeの不一致** | **要確認**: 検証が必要 |

**VBA Stomping 検出について**:
- olevbaは「実験的機能」として検出したことを明記
- 誤検出の可能性あり
- 悪意のある改ざんではなく、Excel/VBAエディタのバージョン違いで発生することが多い

**総合評価**: **概ね安全（VBA Stompingは誤検出の可能性大）**

---

## 7. 推奨事項

### コードメンテナンス
1. **基幹システム連携.xlsm**
   - Module1, Module2は削除推奨（Module3が最新版）
   - バージョン管理システム（Git等）で履歴管理を推奨

2. **検査証_一般.xlsm**
   - 外部ファイルパス `ああああ.xlsx` を設定ファイル化
   - セル座標のハードコーディングを名前付き範囲に変更

### セキュリティ
1. **VBAプロジェクトのパスワード保護**
   - 不正な改変を防ぐため、パスワード設定を推奨

2. **VBA Stompingの確認**
   - 検査証_一般.xlsmを最新のExcelで開き、VBAエディタで再保存
   - olevbaで再スキャンし、警告が消えることを確認

3. **外部ファイル参照の相対パス化**
   - 絶対パスを避け、相対パスまたは設定ファイル管理

### ドキュメント化
1. **ユーザーマニュアルの作成**
   - 各機能の使用方法
   - エラー時の対処法

2. **開発者向けドキュメント**
   - データフロー図
   - API依存関係
   - セル配置仕様

---

## 8. まとめ

### 基幹システム連携.xlsm
- **用途**: 基幹システム（QBIS）への発注データ自動入力
- **機密情報**: システム名以外、重大な機密情報なし
- **コード品質**: 段階的リファクタリングの過程が残っている（最新版はModule3）
- **セキュリティ**: 安全（疑わしいAPI使用は業務自動化の正当用途）

### 検査証_一般.xlsm
- **用途**: 検査証データ管理・印刷システム
- **機密情報**: 外部ファイル参照以外、重大な機密情報なし
- **コード品質**: クラス設計、イベント駆動、モジュール分割が適切
- **セキュリティ**: 概ね安全（VBA Stompingは誤検出の可能性大）

### 総合評価
✓ 両ファイルとも**業務自動化ツール**として設計されている
✓ 悪意のあるコードは検出されず
✓ 機密情報の流出リスクは**低い**
✓ コードは**可読性が高く**、保守性も確保されている

---

**分析日時**: 2025-10-13
**分析ツール**: olevba 0.60.2, Python 3.13.5
